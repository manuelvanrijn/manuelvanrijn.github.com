<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Manuel van Rijn]]></title>
  <link href="http://manuel.manuelles.nl/atom.xml" rel="self"/>
  <link href="http://manuel.manuelles.nl/"/>
  <updated>2013-07-04T09:29:08+02:00</updated>
  <id>http://manuel.manuelles.nl/</id>
  <author>
    <name><![CDATA[Manuel van Rijn]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Rails belongs_to to has_many]]></title>
    <link href="http://manuel.manuelles.nl/blog/2013/03/04/rails-belongs-to-to-has-many/"/>
    <updated>2013-03-04T17:19:00+01:00</updated>
    <id>http://manuel.manuelles.nl/blog/2013/03/04/rails-belongs-to-to-has-many</id>
    <content type="html"><![CDATA[<p><a href="http://manuel.manuelles.nl/blog/2013/03/04/rails-belongs-to-to-has-many/"><img class="left" src="http://manuel.manuelles.nl/images/posts/habtm-migration.jpg" width="250" height="250" title="Migration what?!" ></a> Today I had to change a <code>belongs_to</code> associate to an <code>has_and_belongs_to_many</code> in a Rails project I&#8217;m currently working on. Not that hard you would say, but there were some catches for deploying/migrating these changes to the production environment.</p>

<br />


<p>In this post I&#8217;d like to explain how to achieve this without having to do multiple deployments of your model to maintain a consistent database schema and model.</p>

<!-- more -->


<h2>TL;DR;</h2>

<p>Here you can find <a href="#final-migration">the final migration</a>. Note that this example could also be solved with plain sql instead of using ActiveRecord, but there might be cases were you depend on the ActiveRecord associates. In these cases this is a great workaround</p>

<h2>The problem</h2>

<p>Let&#8217;s say we have a Article that belongs to a Category. Our model would look like something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Article</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="n">attr_accessible</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">:content</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:category</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>And the executed migration would look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">CreateArticle</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Migration</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">change</span>
</span><span class='line'>    <span class="n">create_table</span> <span class="ss">:articles</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:title</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">text</span> <span class="ss">:content</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">references</span> <span class="ss">:category</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>The initial migration</h2>

<p>First let&#8217;s create a new table that can hold the associate between multiple Articles and Categories. The migration would look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">MultipleCategoriesForArticles</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Migration</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">up</span>
</span><span class='line'>    <span class="n">create_table</span> <span class="ss">:articles_categories</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="kp">false</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">references</span> <span class="ss">:article</span><span class="p">,</span> <span class="ss">:category</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">down</span>
</span><span class='line'>    <span class="n">drop_table</span> <span class="ss">:articles_categories</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>At this point all is fine and we can migrate the database without any problems. Only this doesn&#8217;t add the current category to the new collection of categories.</p>

<h3>Moving the belongs_to associate</h3>

<p>Here&#8217;s were the problem actually starts, because to move the category to the categories collection for the articles, we have to define the <code>belongs_to</code> but also the <code>has_and_belongs_to_many</code> associate on the <code>Article</code> model.</p>

<p>I don&#8217;t like this approach because we&#8217;ll have to define both these associates and the <code>belongs_to</code> should be removed in the next release. So how to deal with this?</p>

<p><a id="final-migration"></a></p>

<h2>The fix</h2>

<p>The fix is quite simple. We remove the <code>belongs_to</code> associate from the model and only define the new <code>has_and_belongs_to_many</code> associate and within the migration we extend the model with the &#8220;old&#8221; <code>belongs_to</code> associate so we can use this within the migration.</p>

<p>So our files will look like this</p>

<figure class='code'><figcaption><span>app/models/article.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Article</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="n">attr_accessible</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">:content</span>
</span><span class='line'>  <span class="n">has_and_belongs_to_many</span> <span class="ss">:categories</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>db/migrate/20130305120000_multiple_categories_for_articles.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">MultipleCategoriesForArticles</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Migration</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">up</span>
</span><span class='line'>    <span class="n">create_table</span> <span class="ss">:articles_categories</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="kp">false</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">references</span> <span class="ss">:article</span><span class="p">,</span> <span class="ss">:category</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># define the old belongs_to category associate</span>
</span><span class='line'>    <span class="no">Article</span><span class="o">.</span><span class="n">class_eval</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">belongs_to</span> <span class="ss">:old_category</span><span class="p">,</span>
</span><span class='line'>                 <span class="ss">:class_name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Category&quot;</span><span class="p">,</span>
</span><span class='line'>                 <span class="ss">:foreign_key</span> <span class="o">=&gt;</span> <span class="s2">&quot;category_id&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># add the belongs_to category to the has_and_belongs_to_many categories</span>
</span><span class='line'>    <span class="no">Article</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span> <span class="n">article</span> <span class="o">|</span>
</span><span class='line'>      <span class="n">article</span><span class="o">.</span><span class="n">categories</span> <span class="o">&lt;&lt;</span> <span class="n">article</span><span class="o">.</span><span class="n">old_category</span>
</span><span class='line'>      <span class="n">article</span><span class="o">.</span><span class="n">save</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># remove the old category_id column for the belongs_to associate</span>
</span><span class='line'>    <span class="n">remove_column</span> <span class="ss">:articles</span><span class="p">,</span> <span class="ss">:category_id</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">down</span>
</span><span class='line'>    <span class="n">add_column</span> <span class="ss">:articles</span><span class="p">,</span> <span class="ss">:category_id</span><span class="p">,</span> <span class="ss">:integer</span>
</span><span class='line'>
</span><span class='line'>    <span class="no">Article</span><span class="o">.</span><span class="n">class_eval</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">belongs_to</span> <span class="ss">:new_category</span><span class="p">,</span>
</span><span class='line'>                 <span class="ss">:class_name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Category&quot;</span><span class="p">,</span>
</span><span class='line'>                 <span class="ss">:foreign_key</span> <span class="o">=&gt;</span> <span class="s2">&quot;category_id&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="no">Article</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span> <span class="n">article</span> <span class="o">|</span>
</span><span class='line'>      <span class="c1"># NOTE: we&#39;ll grabe the first category, so if there are more, these will be lost!</span>
</span><span class='line'>      <span class="n">article</span><span class="o">.</span><span class="n">new_category</span> <span class="o">&lt;&lt;</span> <span class="n">article</span><span class="o">.</span><span class="n">categories</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'>      <span class="n">article</span><span class="o">.</span><span class="n">save</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">drop_table</span> <span class="ss">:articles_categories</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Sidekiq on Heroku with Redis To Go Nano]]></title>
    <link href="http://manuel.manuelles.nl/blog/2012/11/13/sidekiq-on-heroku-with-redistogo-nano/"/>
    <updated>2012-11-13T15:42:00+01:00</updated>
    <id>http://manuel.manuelles.nl/blog/2012/11/13/sidekiq-on-heroku-with-redistogo-nano</id>
    <content type="html"><![CDATA[<p><a href="http://manuel.manuelles.nl/blog/2012/11/13/sidekiq-on-heroku-with-redistogo-nano/"><img class="right" src="http://manuel.manuelles.nl/images/posts/redis.png" width="200" height="200" title="Redis" ></a> As a follow-up of <a href="http://manuel.manuelles.nl/blog/2012/11/13/scalable-heroku-worker-for-sidekiq/">my previous post</a> I want to explain how to get <a href="http://sidekiq.org/">Sidekiq</a> to work on <a href="http://www.heroku.com">Heroku</a> with a <a href="https://addons.heroku.com/redistogo">Redis To Go</a> Nano instance.</p>

<p>Because the Nano instance has some connection limitation you have to make some config changes so you won&#8217;t get <code>ERR max number of clients reached</code> error messages.</p>

<!-- more -->


<h2>Why this post</h2>

<p>Today I&#8217;ve been struggling a lot with getting the Sidekiq to work probably with Redis to Go Nano on Heroku. The main problem was I was having difficulties with the amount of connection&#8217;s being created to the Redis server. Because the Nano variant is free but large enough for handling normal sized queues of work, we have to face the limitation of 10 connections.</p>

<h2>A calculation Tool!</h2>

<p>If you just want to know what you need to change/setup you can go directly to a small tool I&#8217;ve built to calculate the number of connections/concurrencies need for a number of workers/web workers etc.</p>

<p><a href="http://manuel.manuelles.nl/sidekiq-heroku-redis-calc" class="special_button">SidekiqHerokuRedis calculator</a></p>

<h2>Why ERR max number of clients reached?</h2>

<p>The error <code>Error fetching message: ERR max number of clients reached</code>, is quite clear isn&#8217;t it? The actual question is how we can reduce the connections being opened to match the 10 connection limit given by the Nano instance.</p>

<p>After some research I found the factors that you have to tweak in order to reach the magic number of 10.</p>

<ol>
<li>Sidekiq Client connection size</li>
<li>Sidekiq Server connection size</li>
<li>Sidekiq Server reserved connections (reserved for the Fetcher and Retrier)</li>
<li>Sidekiq concurrency size</li>
<li>Unicorn worker_process size</li>
<li>Heroku Web Dyno count</li>
<li>Heroku Worker count</li>
</ol>


<p>The answer for all our problems could be described in the following sum:</p>

<p>max connections = (Heroku worker count * (concurrency + 2 reserved connections)) + (web dyno count * (client connection size * unicorn worker_process size))</p>

<h2>Connections and concurrencies</h2>

<p>If you have a small amount of Redis connections we need to make some modifications in order to get all our processes happy and not throwing connection errors around.</p>

<p>At the bottom of this post I&#8217;ll put my final configuration files.</p>

<h3>Dynos * (unicorns * client size)</h3>

<p>The first thing I changed was the Redis connection size for the client. By default Sidekiq takes <strong>5</strong> connections per client. Because my applications only queries Redis for adding tasks to the Sidekiq queue, one connection should be more than enough.</p>

<p><span class='pullquote-right' data-pullquote='3 workers * dyno count = redis_connections'>
One mistake I made was forgetting about the number of dynos and Unicorn worker_process size. In my <code>app/config/unicorn.rb</code> I had <code>worker_processes 3</code> defined which actually means 3 workers * dyno count = redis_connections taken by the Client.
</span></p>

<h4>Examples:</h4>

<p>In my case where I&#8217;ve set the connection size to one we could have the following examples</p>

<ol>
<li><strong>1</strong> web dyno with <strong>2</strong> unicorn worker_processes takes <strong>2 Redis connections</strong></li>
<li><strong>2</strong> web dyno with <strong>2</strong> unicorn worker_processes takes <strong>4 Redis connections</strong></li>
<li><strong>5</strong> web dyno with <strong>4</strong> unicorn worker_processes takes <strong>20 Redis connections</strong></li>
</ol>


<p>If you up the client size to, for example 3 you should also multiply the Redis connections by this number (so for example 3 you&#8217;ll have 20 * 3 = 60 connections).</p>

<h3>Worker * (concurrency + 2)</h3>

<p>When calculating the number of connections the Sidekiq server needs, we need to modify the number of currencies it initializes on launch. This number represents the number of threads created by the Sidekiq server which will perform queued tasks. Each concurrency/thread takes up 1 Redis connection.</p>

<p>When tweaking this number I found out the Sidekiq server took 2 additional connections upon the concurrency number. This seemed to be default behavior becase Sidekiq server uses these two for the Fetcher and Retrier commands.</p>

<h4>Examples:</h4>

<ol>
<li><strong>1</strong> worker dyno running Sidekiq, with <strong>1</strong> concurrency takes <strong>3 Redis connections</strong></li>
<li><strong>1</strong> worker dyno running Sidekiq, with <strong>2</strong> concurrency takes <strong>4 Redis connections</strong></li>
<li><strong>2</strong> worker dyno running Sidekiq, with <strong>2</strong> concurrency takes <strong>8 Redis connections</strong></li>
</ol>


<p>The default concurrency size of Sidekiq is set to 25 which mean that without modifications you need at least 27 Redis connections for the Sidekiq server.</p>

<h2>My final code</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>connection limit:           10
</span><span class='line'>unicorn processes:           3
</span><span class='line'>web dynos:                   2
</span><span class='line'>worker dynos <span class="o">(</span>sidekiq<span class="o">)</span>:      1
</span><span class='line'>client pool size:            1
</span><span class='line'>server pool size:            2
</span><span class='line'>concurrency:                 2
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>app/config/initializers/sidekiq.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;sidekiq&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="no">Sidekiq</span><span class="o">.</span><span class="n">configure_client</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">redis</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:size</span> <span class="o">=&gt;</span> <span class="mi">1</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">Sidekiq</span><span class="o">.</span><span class="n">configure_server</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">redis</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:size</span> <span class="o">=&gt;</span> <span class="mi">2</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>app/config/sidekiq.yml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">:concurrency</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">2</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>Procfile</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>web: bundle <span class="nb">exec </span>unicorn -p <span class="nv">$PORT</span> -c ./config/unicorn.rb
</span><span class='line'>worker: bundle <span class="nb">exec </span>sidekiq -e production -C config/sidekiq.yml
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>app/config/unicorn.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">worker_processes</span> <span class="mi">3</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Scalable Heroku worker for Sidekiq]]></title>
    <link href="http://manuel.manuelles.nl/blog/2012/11/13/scalable-heroku-worker-for-sidekiq/"/>
    <updated>2012-11-13T09:02:00+01:00</updated>
    <id>http://manuel.manuelles.nl/blog/2012/11/13/scalable-heroku-worker-for-sidekiq</id>
    <content type="html"><![CDATA[<p><a href="http://manuel.manuelles.nl/blog/2012/11/13/scalable-heroku-worker-for-sidekiq/"><img class="left" src="http://manuel.manuelles.nl/images/posts/more-workers.jpg" width="200" height="200" title="More workers" ></a> In this post I&#8217;d like to show you guys how to deploy your Rails application to <a href="http://www.heroku.com/">Heroku</a> with a <a href="http://sidekiq.org/">Sidekiq</a> worker that only gets initiated when there are tasks in the queue to process.</p>

<p>Our goal is to start a worker when a task is added to the queue and to destroy the worker after its done processing the queue tasks. This will result in a much lower bill at the end of the month because the worker doesn&#8217;t have to be up the whole month.</p>

<!-- more -->


<h2>Setting up Sidekiq</h2>

<p>First let&#8217;s take a look at a default configuration of Sidekiq within a Rails project.</p>

<h3>Add the gem</h3>

<p>First we need to add Sidekiq to our Gemfile and run <code>bundle install</code></p>

<figure class='code'><figcaption><span>Gemfile</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s1">&#39;sidekiq&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Create a Sidekiq worker</h3>

<p>The worker is very basic. It just performs some heavy task and sends an email after it finished.</p>

<figure class='code'><figcaption><span>app/workers/my_worker.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">MyWorker</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">Sidekiq</span><span class="o">::</span><span class="no">Worker</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">perform</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
</span><span class='line'>    <span class="n">object</span> <span class="o">=</span> <span class="no">Model</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
</span><span class='line'>    <span class="n">object</span><span class="o">.</span><span class="n">generate_download</span>
</span><span class='line'>    <span class="no">UserMailer</span><span class="o">.</span><span class="n">download_is_ready</span><span class="p">(</span><span class="n">object</span><span class="p">)</span><span class="o">.</span><span class="n">deliver</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Procfile</h3>

<p>In our Procfile we have to define the <code>worker</code> line to start the Sidekiq server on a Heroku worker dyno.</p>

<figure class='code'><figcaption><span>Procfile</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>web: bundle <span class="nb">exec </span>unicorn -p <span class="nv">$PORT</span> -c ./config/unicorn.rb
</span><span class='line'>worker: bundle <span class="nb">exec </span>sidekiq -e production
</span></code></pre></td></tr></table></div></figure>


<h3>Move heavy task to the queue</h3>

<p>On the controller we probably have a line calling <code>object.generate_download</code> which takes to much time. We&#8217;ll change this line to execute the <code>MyWorker</code> instead:</p>

<figure class='code'><figcaption><span>app/controllers/download_controller.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">DownloadController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">generate</span>
</span><span class='line'>    <span class="n">object</span> <span class="o">=</span> <span class="no">Model</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">param</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="c1"># instead of calling object.generate_download we&#39;ll do:</span>
</span><span class='line'>    <span class="no">MyWorker</span><span class="o">.</span><span class="n">perform_async</span><span class="p">(</span><span class="n">object</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>NOTE:</strong> It&#8217;s recommended not to add the whole object into the worker because this is stored in the Redis database. Also the object might be changed before it&#8217;s being processed by Sidekiq. Adding the <code>id</code> and fetching the object in the worker is a better approach.</p>

<h2>So far&#8230;</h2>

<p>At this point we have configured our Rails project to add tasks to Redis and have Sidekiq perform executing the worker when a task is added. If we deploy our Rails app to Heroku we need to add the Redis To Go addon and add a Heroku worker dyno to our application.</p>

<h3>Running locally</h3>

<p>To test this locally we need:</p>

<ul>
<li>Redis installed locally and running</li>
<li>Run the Rails app (<code>bundle exec rails server</code>)</li>
<li>Run the Sidekiq server (<code>bundle exec sidekiq</code>)</li>
</ul>


<h2>Adding the autoscaler</h2>

<p>At this point the Heroku worker dyno has to be started, to pickup tasks from the queue. It&#8217;s likely you do not need this worker to run the whole day because the queue might be empty most of the time. Here&#8217;s where the <a href="http://github.com/JustinLove/autoscaler/">autoscaler gem</a> come&#8217;s in handy.</p>

<p>This gem acts as Middleware for Sidekiq and performs the following tasks:</p>

<ol>
<li>When a task is added it checks if a Worker is present.</li>
<li>When a worker is already running it does nothing and the worker will pickup the task.</li>
<li>If there isn&#8217;t a worker running it will create a Heroku worker dyno.</li>
<li>If the worker finished processing the queue it will keep the worker alive for 60 seconds just in case we add a task to the queue within this time. If no tasks are added it will destroy the worker.</li>
</ol>


<h3>Add the gem</h3>

<p>First we need to add the autoscaler gem to our Gemfile and run <code>bundle install</code></p>

<figure class='code'><figcaption><span>Gemfile</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s1">&#39;autoscaler&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Adding required ENV variables</h3>

<p>The gem requires two environment variables to be set on your Heroku application. The <code>HEROKU_API_KEY</code> is required to perform creating and removing a Heroku worker dyno and the <code>HEROKU_APP</code> to know on which application it has to create/destroy the worker dyno on.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># API KEY can be found on https://dashboard.heroku.com/account</span>
</span><span class='line'>heroku config:add <span class="nv">HEROKU_API_KEY</span><span class="o">=</span>123-your-key-456
</span><span class='line'>heroku config:add <span class="nv">HEROKU_APP</span><span class="o">=</span>your_heroku_app_name
</span></code></pre></td></tr></table></div></figure>


<h3>Tweaking the Sidekiq initializer</h3>

<p>Because this gem acts as Middleware we need to create a <code>sidekiq.rb</code> in our initializers folder. This file will check if we are running on Heroku and if so, activates the autoscaler as Middleware.</p>

<figure class='code'><figcaption><span>app/config/initializers/sidekiq.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;sidekiq&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;autoscaler/sidekiq&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;autoscaler/heroku_scaler&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">heroku</span> <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'><span class="k">if</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;HEROKU_APP&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="n">heroku</span> <span class="o">=</span> <span class="no">Autoscaler</span><span class="o">::</span><span class="no">HerokuScaler</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">Sidekiq</span><span class="o">.</span><span class="n">configure_client</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">heroku</span>
</span><span class='line'>    <span class="n">config</span><span class="o">.</span><span class="n">client_middleware</span> <span class="k">do</span> <span class="o">|</span><span class="n">chain</span><span class="o">|</span>
</span><span class='line'>      <span class="n">chain</span><span class="o">.</span><span class="n">add</span> <span class="no">Autoscaler</span><span class="o">::</span><span class="no">Sidekiq</span><span class="o">::</span><span class="no">Client</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span> <span class="o">=&gt;</span> <span class="n">heroku</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">Sidekiq</span><span class="o">.</span><span class="n">configure_server</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">server_middleware</span> <span class="k">do</span> <span class="o">|</span><span class="n">chain</span><span class="o">|</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">heroku</span>
</span><span class='line'>      <span class="nb">p</span> <span class="s2">&quot;[Sidekiq] Running on Heroku, autoscaler is used&quot;</span>
</span><span class='line'>      <span class="n">chain</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="no">Autoscaler</span><span class="o">::</span><span class="no">Sidekiq</span><span class="o">::</span><span class="no">Server</span><span class="p">,</span> <span class="n">heroku</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span> <span class="c1"># 60 seconds timeout</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="nb">p</span> <span class="s2">&quot;[Sidekiq] Running locally, so autoscaler isn&#39;t used&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Ready to go!</h2>

<p>At this point we&#8217;re ready to deploy our application to Heroku and let the autscaler automatically create and destroy a worker dyno whenever it needs to process tasks from the Sidekiq queue.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Yeoman meets Travis CI]]></title>
    <link href="http://manuel.manuelles.nl/blog/2012/09/17/yeoman-meets-travis-ci/"/>
    <updated>2012-09-17T14:45:00+02:00</updated>
    <id>http://manuel.manuelles.nl/blog/2012/09/17/yeoman-meets-travis-ci</id>
    <content type="html"><![CDATA[<p><a href="http://manuel.manuelles.nl/blog/2012/06/22/integrate-travis-ci-into-grunt/"><img class="right" src="http://manuel.manuelles.nl/images/posts/yeoman-logo.png" width="200" height="200" title="Yeoman" ></a> Today I&#8217;d like to show how you can integrate Travis CI within your Yeoman project.</p>

<p><a href="http://travis-ci.org/">Travis CI</a> is a hosted continuous integration service for open source projects and <a href="http://yeoman.io">Yeoman</a> is a robust and opinionated set of tools, libraries, and a workflow that can help developers quickly build beautiful, compelling web apps.</p>

<!-- more -->


<h2>Adding Travis CI support</h2>

<p>When Yeoman was released I&#8217;ve tried to add Travis CI support to a test project. After setting everything up there seemed to be a problem with the update check being fired when running tests. This was annoying because Travis CI was waiting for input from the user.</p>

<p>So I&#8217;ve fixed the issue and created a <a href="https://github.com/yeoman/yeoman/pull/369">pull request</a> that was merged very quick thanks to <a href="http://www.addyosmani.com">Addy Osmani</a>.</p>

<p>Anyway today I saw that there was a new version released which includes my fix and I like to share how you can make your Yeoman project be tested within Travis CI.</p>

<h3>TL;DR;</h3>

<p>See <a href="https://github.com/manuelvanrijn/yeoman-travis-ci/commit/32203d84ca2dbba2faa671e55afede8a1e6666df">this commit</a> with all the changes you have to make to your existing Yeoman project in order to get Travis CI integration.</p>

<p>Or just browse my test project here: <a href="https://github.com/manuelvanrijn/yeoman-travis-ci">yeoman-travis-ci</a></p>

<h3>package.json</h3>

<h4>Adding the yeoman dependency</h4>

<p>First we have to add the yeoman package as a dependency to our <code>package.json</code> file because we can&#8217;t install yeoman globally on Travis CI.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="s">&quot;devDependencies&quot;</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span>
</span><span class='line'>  <span class="s">&quot;yeoman&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;~0.9.1&quot;</span>
</span><span class='line'><span class="p-Indicator">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>After adding the dependency and running <code>npm install</code> you&#8217;ll see that yeoman is installed in the <code>node_modules</code> folder of your project.</p>

<h4>Setup npm test script</h4>

<p>Travis CI runs the <code>npm test</code> command after fetching the project and installing the dependencies. To make npm test run the Yeoman test task, we need to add the following line into our <code>package.json</code> file.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="s">&quot;scripts&quot;</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span>
</span><span class='line'>  <span class="s">&quot;test&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;node_modules/.bin/yeoman</span><span class="nv"> </span><span class="s">test</span><span class="nv"> </span><span class="s">--verbose&quot;</span>
</span><span class='line'><span class="p-Indicator">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>I&#8217;ve added the <code>--verbose</code> argument because I&#8217;d like to see detailed information when my tests fail, but this is an optional argument.</p>

<p>At this point you should be able to run <code>npm test</code> and see Yeoman running your tests.</p>

<h3>Add the .travis.yml file</h3>

<p>Finally we have to add a <code>.travis.yml</code> file to let Travis CI know what language our project is and on which version(s) of NodeJS it should use to test our project against (note: Yeoman requires >= 0.8).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">language</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">node_js</span>
</span><span class='line'><span class="l-Scalar-Plain">node_js</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">0.8</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">0.9</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Hook &amp; Push!</h2>

<p>The final step is to add the Travis CI hook to you project in GitHub and push your project.</p>

<p>Happy coding!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[SELECT total_rows FROM database]]></title>
    <link href="http://manuel.manuelles.nl/blog/2012/07/26/select-total-rows-from-database/"/>
    <updated>2012-07-26T14:34:00+02:00</updated>
    <id>http://manuel.manuelles.nl/blog/2012/07/26/select-total-rows-from-database</id>
    <content type="html"><![CDATA[<p><a href="http://manuel.manuelles.nl/blog/2012/07/26/select-total-rows-from-database/"><img class="left" src="http://manuel.manuelles.nl/images/posts/heroku-postgres.png" width="200" height="200" title="Heroku Postgres" ></a> On the first of August this year, <a href="http://www.heroku.com">Heroku</a> will add 2 new plans to their database add-on known as <strong>Dev</strong> and <strong>Basic</strong>. Both plans have a row limit restriction and that made me thinking how I could fetch that number with one simple query.</p>

<!-- more -->




<div class="clearfix"></div>


<h2>TL;DR</h2>

<p>Of course you already know the stuff described below so go to <a href="#final-query">the final query</a>.</p>

<h2>Getting the list with tables</h2>

<p>For retrieving almost any information about your database you can query the <code>pg_class</code> see <a href="http://www.postgresql.org/docs/9.1/static/catalog-pg-class.html">Postgres documentation</a>.</p>

<ul>
<li>The <code>relkind</code> is set to <code>r</code> to query only ordinary table information.</li>
<li>We are joining the <code>pg_namespace</code> table to filter out the <code>pg_catalog</code> and <code>information_schema</code> tables</li>
</ul>


<p>As result we&#8217;ll have on column called <code>tableName</code> with all tables from the database</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span>
</span><span class='line'>  <span class="n">pgClass</span><span class="p">.</span><span class="n">relname</span> <span class="k">AS</span> <span class="n">tableName</span>
</span><span class='line'><span class="k">FROM</span>
</span><span class='line'>  <span class="n">pg_class</span> <span class="n">pgClass</span>
</span><span class='line'><span class="k">LEFT</span> <span class="k">JOIN</span>
</span><span class='line'>  <span class="n">pg_namespace</span> <span class="n">pgNamespace</span> <span class="k">ON</span> <span class="p">(</span><span class="n">pgNamespace</span><span class="p">.</span><span class="n">oid</span> <span class="o">=</span> <span class="n">pgClass</span><span class="p">.</span><span class="n">relnamespace</span><span class="p">)</span>
</span><span class='line'><span class="k">WHERE</span>
</span><span class='line'>  <span class="n">pgNamespace</span><span class="p">.</span><span class="n">nspname</span> <span class="k">NOT</span> <span class="k">IN</span> <span class="p">(</span><span class="s1">&#39;pg_catalog&#39;</span><span class="p">,</span> <span class="s1">&#39;information_schema&#39;</span><span class="p">)</span> <span class="k">AND</span>
</span><span class='line'>  <span class="n">pgClass</span><span class="p">.</span><span class="n">relkind</span><span class="o">=</span><span class="s1">&#39;r&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Adding the row count</h3>

<p>Adding the total number of rows was quite simple after reading the <a href="http://www.postgresql.org/docs/9.1/static/catalog-pg-class.html">Postgres documentation</a>. It seems that the <code>pg_class</code> contains a column called <code>reltuples</code> that holds the number of rows in the table.</p>

<p>So adding this column to the select seems to do the trick:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span>
</span><span class='line'>  <span class="n">pgClass</span><span class="p">.</span><span class="n">relname</span>   <span class="k">AS</span> <span class="n">tableName</span><span class="p">,</span>
</span><span class='line'>  <span class="n">pgClass</span><span class="p">.</span><span class="n">reltuples</span> <span class="k">AS</span> <span class="n">rowCount</span>
</span><span class='line'><span class="k">FROM</span>
</span><span class='line'>  <span class="n">pg_class</span> <span class="n">pgClass</span>
</span><span class='line'><span class="k">LEFT</span> <span class="k">JOIN</span>
</span><span class='line'>  <span class="n">pg_namespace</span> <span class="n">pgNamespace</span> <span class="k">ON</span> <span class="p">(</span><span class="n">pgNamespace</span><span class="p">.</span><span class="n">oid</span> <span class="o">=</span> <span class="n">pgClass</span><span class="p">.</span><span class="n">relnamespace</span><span class="p">)</span>
</span><span class='line'><span class="k">WHERE</span>
</span><span class='line'>  <span class="n">pgNamespace</span><span class="p">.</span><span class="n">nspname</span> <span class="k">NOT</span> <span class="k">IN</span> <span class="p">(</span><span class="s1">&#39;pg_catalog&#39;</span><span class="p">,</span> <span class="s1">&#39;information_schema&#39;</span><span class="p">)</span> <span class="k">AND</span>
</span><span class='line'>  <span class="n">pgClass</span><span class="p">.</span><span class="n">relkind</span><span class="o">=</span><span class="s1">&#39;r&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p><a id="final-query"></a></p>

<h2>Selecting the total count</h2>

<p>With this query it was easy to transform it into a SUM for all rowCount&#8217;s we retrieve. Here&#8217;s the final query to retrieve the total number of rows from all tables of a Postgres database</p>

<div><script src='https://gist.github.com/3205631.js'></script>
<noscript><pre><code>SELECT
  SUM(pgClass.reltuples) AS totalRowCount
FROM
  pg_class pgClass
LEFT JOIN
  pg_namespace pgNamespace ON (pgNamespace.oid = pgClass.relnamespace)
WHERE
  pgNamespace.nspname NOT IN (&#39;pg_catalog&#39;, &#39;information_schema&#39;) AND
  pgClass.relkind=&#39;r&#39;</code></pre></noscript></div>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Integrate Travis CI into Grunt]]></title>
    <link href="http://manuel.manuelles.nl/blog/2012/06/22/integrate-travis-ci-into-grunt/"/>
    <updated>2012-06-22T15:04:00+02:00</updated>
    <id>http://manuel.manuelles.nl/blog/2012/06/22/integrate-travis-ci-into-grunt</id>
    <content type="html"><![CDATA[<p><a href="http://manuel.manuelles.nl/blog/2012/06/22/integrate-travis-ci-into-grunt/"><img class="right" src="http://manuel.manuelles.nl/images/posts/travis-grunt.jpg" width="200" height="200" title="Code Fail" ></a> Today I&#8217;ve done some research how to get my latest jQuery plugin (<a href="http://manuel.manuelles.nl/jquery-numeric_input/">jquery-numeric_input</a>) to be tested automatically with the help of <a href="http://travis-ci.org/">Travis CI</a>. Travis CI is a hosted continuous integration service for open source projects.</p>

<p>Because I&#8217;ve just finished the latest functionality of the plugin I wanted to add the project to Travis CI, just like I do with all my other projects (the ones with unit tests).</p>

<!-- more -->


<h2>Grunt</h2>

<p>For the development of the plugin I used <a href="http://gruntjs.com/">Grunt</a> which is a task-based command line build tool for JavaScript projects. Starting a new project is as easy as running <code>grunt init:jquery</code> and you have a entire generated jQuery plugin project.</p>

<p>By default this command configures a jQuery plugin, QUnit test suite, sample plugin, sample tests and some grunt tasks you can use. Running the <code>grunt</code> command in your project folder will execute the default task meaning:</p>

<ol>
<li>lint - Analysis your code with <a href="https://github.com/douglascrockford/JSLint/">JSLint</a></li>
<li>qunit - Runs your QUnit tests using <a href="http://phantomjs.org/">PhantomJS</a> (so it supports the exit code for success or failure)</li>
<li>concat - Concatenate your project files</li>
<li>min - Minify your project files using <a href="https://github.com/mishoo/UglifyJS/">UglifyJS</a></li>
</ol>


<p>Really easy to get started coding instead of setting up your environment :)</p>

<h2>Integration with Travis CI</h2>

<p>Ok so at this point I want to add my project to Travis CI so that it tests my suite when pushing new branches/commits to Github. To do this we have to make a few changes.</p>

<h3>TL;DR</h3>

<p>Here&#8217;s the <a href="https://github.com/manuelvanrijn/jquery-numeric_input/commit/188e1fa53ca565b2901f0ac4b6de102b6349577b">travis ci integration commit</a> from my plugin with all the steps described below.</p>

<h3>Registering the travis task</h3>

<p>I&#8217;d like to keep the Grunt tasks organized so I register a new task called <code>travis</code> below the <code>default</code> task.</p>

<figure class='code'><figcaption><span>grunt.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// Default task.</span>
</span><span class='line'><span class="nx">grunt</span><span class="p">.</span><span class="nx">registerTask</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="s1">&#39;lint qunit concat min&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Travis CI task.</span>
</span><span class='line'><span class="nx">grunt</span><span class="p">.</span><span class="nx">registerTask</span><span class="p">(</span><span class="s1">&#39;travis&#39;</span><span class="p">,</span> <span class="s1">&#39;lint qunit&#39;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see I only added <code>lint</code> and <code>qunit</code> because we don&#8217;t have to concatenate or minify a new build of our plugin. At this point you are able to run <code>grunt travis</code> from the command line.</p>

<h3>Adding the dependency</h3>

<p>Now we have to add Grunt as a dependency to our <code>package.json</code> file so that npm running on Travis CI knows it has to install Grunt. Mine dependencies block looks like this:</p>

<figure class='code'><figcaption><span>package.json</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="s2">&quot;dependencies&quot;</span><span class="err">:</span> <span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;jQuery&quot;</span><span class="p">:</span> <span class="s2">&quot;~1.7.3&quot;</span>
</span><span class='line'><span class="p">}</span><span class="err">,</span>
</span><span class='line'><span class="s2">&quot;devDependencies&quot;</span><span class="err">:</span> <span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;grunt&quot;</span><span class="p">:</span> <span class="s2">&quot;~0.3.14&quot;</span>
</span><span class='line'><span class="p">}</span><span class="err">,</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Adding the npm task</h3>

<p>Travis CI runs <code>npm test</code> after it fetched your project and installed the dependencies, so we need to add this task to the <code>package.json</code> file.</p>

<figure class='code'><figcaption><span>package.json</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="s2">&quot;scripts&quot;</span><span class="err">:</span> <span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;test&quot;</span><span class="p">:</span> <span class="s2">&quot;grunt travis --verbose&quot;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>I&#8217;ve added the <code>--verbose</code> option, so we&#8217;ll see more output of what is going on.</p>

<h3>Adding the .travis.yml</h3>

<p>Every Travis CI project needs to have a <code>.travis.yml</code> file in the root of the project folder, so it know what platform and version it should use to build/test your project. Here&#8217;s the one I used:</p>

<figure class='code'><figcaption><span>.travis.yml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">language</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">node_js</span>
</span><span class='line'><span class="l-Scalar-Plain">node_js</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">0.6</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">0.8</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">0.9</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Ready to go!</h2>

<p>Alright after these changes your project is ready to be continuously builded with Travis CI. But don&#8217;t forget to setup the Service Hook on Github!</p>

<h2>Update</h2>

<p>Thanks to <strong>Ryan Seddon</strong> and <strong>Ariya Hidayat</strong> for noticing me that the <code>before_script</code> section for running PhantomJS on the headless server on Travis CI isn&#8217;t needed. See <a href="http://about.travis-ci.org/docs/user/gui-and-headless-browsers/">this link</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Taking MemSQL for a spin]]></title>
    <link href="http://manuel.manuelles.nl/blog/2012/06/20/taking-memsql-for-a-spin/"/>
    <updated>2012-06-20T10:18:00+02:00</updated>
    <id>http://manuel.manuelles.nl/blog/2012/06/20/taking-memsql-for-a-spin</id>
    <content type="html"><![CDATA[<p><a href="http://manuel.manuelles.nl/blog/2012/06/20/taking-memsql-for-a-spin/"><img class="left" src="http://manuel.manuelles.nl/images/posts/memsql.png" width="200" height="200" title="MemSQL" ></a> This week I read an article on <a href="http://news.ycombinator.com/item?id=4126007">HackerNews</a> about Ex-facebook employs releasing a new database server called MemSQL.</p>

<p>After viewing there <a href="http://developers.memsql.com/">product overview video</a> I got excited and wanted to take this product for a spin.</p>

<!-- more -->


<h2>What to test?</h2>

<p>First I needed a project for testing the performance on. At <a href="http://www.auxilium.nl">my work</a> we developed a Rails application that needs to validate a permit request with rules, questions, filters, answers depending on a region etc. etc. This process of validating a whole permit request takes some time because it has to perform <strong>6850 queries</strong>.</p>

<h2>Performance PostgreSQL</h2>

<p>At this moment the application runs on a PostgreSQL database so lets see what the performance is at this point:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>run       user     system      total        real
</span><span class='line'>#01  10.690000   0.540000  11.230000 ( 14.828312)
</span><span class='line'>#02   9.450000   0.490000   9.940000 ( 13.895988)
</span><span class='line'>#03   9.550000   0.470000  10.020000 ( 14.215028)</span></code></pre></td></tr></table></div></figure>


<p><span class='pullquote-right' data-pullquote='14.312ms for 6850 queries'>
The average result is that it takes 14.312ms for 6850 queries on PostgreSQL.
</span></p>

<h2>Configuring the Rails app to use MemSQL</h2>

<p>After installing MemSQL and starting it running on port 3307, I created a new database added the existing data and changed some connection strings for the Rails app.</p>

<h3>mysql2 gem</h3>

<p>Because MemSQL is built on top of MySQL you can use all the MySQL client tools to perform operations on MemSQL.</p>

<p>The MemSQL documentation recommended using the memsql2 gem but to do this I had to install MySQL first on my machine.</p>

<h3>Failed to connect?</h3>

<p>After installing MySQL and configured the Rails application I got some strange error when starting the application.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Failed to connect to database:
</span><span class='line'>  Sequel::AdapterNotFound -&gt; LoadError: dlopen(.rbenv/versions/1.9.3-p194/lib/ruby/gems/1.9.1/gems/mysql2-0.3.11/lib/mysql2/mysql2.bundle, 9): Library not loaded: /usr/local/mysql/lib/libmysqlclient.16.dylib
</span><span class='line'>  Referenced from: /Users/mvanrijn/.rbenv/versions/1.9.3-p194/lib/ruby/gems/1.9.1/gems/mysql2-0.3.11/lib/mysql2/mysql2.bundle
</span><span class='line'>  Reason: image not found - /Users/mvanrijn/.rbenv/versions/1.9.3-p194/lib/ruby/gems/1.9.1/gems/mysql2-0.3.11/lib/mysql2/mysql2.bundle</span></code></pre></td></tr></table></div></figure>


<p>After some googling I found out that on OSX you might need to symlink the dylib manually. <strong>NOTE</strong> Because I&#8217;ve installed a newer version of MySQL I have a <code>libmysqlclient.18.dylib</code> instead of the required <code>libmysqlclient.16.dylib</code>. Symlinking this file from libmysqlclient.18.dylib to libmysqlclient.16.dylib seemed to work for me.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo ln -s /usr/local/mysql/lib/libmysqlclient.18.dylib /usr/local/mysql/lib/libmysqlclient.16.dylib</span></code></pre></td></tr></table></div></figure>


<h3>Explain not supported for joins</h3>

<p>At this point I am able to connect to the database and perform the benchmark, but I got the next error:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ActiveRecord::StatementInvalid: Mysql2::Error: Feature 'EXPLAIN for join queries' is not supported by MemSQL.</span></code></pre></td></tr></table></div></figure>


<p>Apparently I&#8217;ve EXPLAIN queries on in my config and this isn&#8217;t supported for JOIN queries as MemSQL tells us.</p>

<p>To resolve this you just have to modify/add this line in your <code>config/environment/development.rb</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>config.active_record.auto_explain_threshold_in_seconds = nil</span></code></pre></td></tr></table></div></figure>


<h2>MemSQL&#8217;s first spin!</h2>

<p><span class='pullquote-right' data-pullquote='first run took 3 min and 05 seconds!'>
So after resolving all these issues I was able to run the benchmark, but the first run took 3 min and 05 seconds! First I thought that this can not be right, but I forgot the fact that it generate&#8217;s c code from the queries.
</span></p>

<p>On the MemSQL server I got the following output:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="mi">2908919519</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">16</span> <span class="n">INFO</span><span class="p">:</span> <span class="n">Query</span> <span class="n">appdb</span><span class="p">.</span><span class="s1">&#39;SELECT  `permit_requests`.* FROM `permit_requests`  WHERE `permit_requests`.`id` = @ LIMIT @&#39;</span> <span class="n">compiled</span> <span class="k">in</span> <span class="mi">7306</span> <span class="n">milliseconds</span>
</span><span class='line'><span class="mi">2908983637</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">16</span> <span class="n">WARNING</span><span class="p">:</span> <span class="n">WARN</span> <span class="n">DISABLED</span> <span class="n">LOCKDOWN</span><span class="p">:</span> <span class="k">BEGIN</span> <span class="n">TRANSACTION</span>
</span><span class='line'><span class="mi">2916240227</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">23</span> <span class="n">INFO</span><span class="p">:</span> <span class="n">Query</span> <span class="n">appdb</span><span class="p">.</span><span class="s1">&#39;SELECT  `categories`.* FROM `categories`  WHERE `categories`.`id` = @ ORDER BY name LIMIT @&#39;</span> <span class="n">compiled</span> <span class="k">in</span> <span class="mi">7203</span> <span class="n">milliseconds</span>
</span><span class='line'><span class="mi">2924143142</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">31</span> <span class="n">INFO</span><span class="p">:</span> <span class="n">Query</span> <span class="n">appdb</span><span class="p">.</span><span class="s1">&#39;SELECT `questions`.* FROM `questions`  WHERE `questions`.`category_id` = @ ORDER BY position&#39;</span> <span class="n">compiled</span> <span class="k">in</span> <span class="mi">7722</span> <span class="n">milliseconds</span>
</span><span class='line'>
</span><span class='line'><span class="p">...</span> <span class="n">etc</span> <span class="p">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, generating the compiled version for every query took about 7 seconds.</p>

<h2>Performance MemSQL</h2>

<p>So below again the same table with results. The first line is the time with generating all the compiled queries:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">run</span>       <span class="k">user</span>     <span class="k">system</span>      <span class="n">total</span>        <span class="nb">real</span>
</span><span class='line'><span class="o">#</span><span class="mi">01</span>   <span class="mi">5</span><span class="p">.</span><span class="mi">260000</span>   <span class="mi">0</span><span class="p">.</span><span class="mi">360000</span>   <span class="mi">5</span><span class="p">.</span><span class="mi">620000</span> <span class="p">(</span><span class="mi">183</span><span class="p">.</span><span class="mi">511099</span><span class="p">)</span>
</span><span class='line'><span class="o">#</span><span class="mi">02</span>   <span class="mi">3</span><span class="p">.</span><span class="mi">830000</span>   <span class="mi">0</span><span class="p">.</span><span class="mi">260000</span>   <span class="mi">4</span><span class="p">.</span><span class="mi">090000</span> <span class="p">(</span>  <span class="mi">6</span><span class="p">.</span><span class="mi">657682</span><span class="p">)</span>
</span><span class='line'><span class="o">#</span><span class="mi">03</span>   <span class="mi">3</span><span class="p">.</span><span class="mi">790000</span>   <span class="mi">0</span><span class="p">.</span><span class="mi">260000</span>   <span class="mi">4</span><span class="p">.</span><span class="mi">050000</span> <span class="p">(</span>  <span class="mi">6</span><span class="p">.</span><span class="mi">613542</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p><span class='pullquote-right' data-pullquote='6.635ms for 6850 queries'>
The performance boost is quite huge! The average result is 6.635ms for 6850 queries if we are skipping the first result. This means it&#8217;s like 7.677ms faster!
</span></p>

<h3>Cold boot of MemSQL</h3>

<p>I&#8217;ve also tried the performance when I restart the database server. I just wanted to know if it keeps the data in memory and would take longer to run after a restart.</p>

<p>The result:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">run</span>       <span class="k">user</span>     <span class="k">system</span>      <span class="n">total</span>        <span class="nb">real</span>
</span><span class='line'><span class="o">#</span><span class="mi">01</span>   <span class="mi">5</span><span class="p">.</span><span class="mi">110000</span>   <span class="mi">0</span><span class="p">.</span><span class="mi">330000</span>   <span class="mi">5</span><span class="p">.</span><span class="mi">440000</span> <span class="p">(</span>  <span class="mi">8</span><span class="p">.</span><span class="mi">030930</span><span class="p">)</span>
</span><span class='line'><span class="o">#</span><span class="mi">02</span>   <span class="mi">3</span><span class="p">.</span><span class="mi">770000</span>   <span class="mi">0</span><span class="p">.</span><span class="mi">260000</span>   <span class="mi">4</span><span class="p">.</span><span class="mi">030000</span> <span class="p">(</span>  <span class="mi">6</span><span class="p">.</span><span class="mi">580312</span><span class="p">)</span>
</span><span class='line'><span class="o">#</span><span class="mi">03</span>   <span class="mi">3</span><span class="p">.</span><span class="mi">780000</span>   <span class="mi">0</span><span class="p">.</span><span class="mi">250000</span>   <span class="mi">4</span><span class="p">.</span><span class="mi">030000</span> <span class="p">(</span>  <span class="mi">6</span><span class="p">.</span><span class="mi">524884</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p><span class='pullquote-right' data-pullquote='7.044ms for 6850 queries'>
The first time it took just a bit longer, but with an average of 7.044ms for 6850 queries this is still faster than running it on PostgreSQL!
</span></p>

<h2>Pros and Cons</h2>

<p>Here&#8217;s a list with some pros and cons I noticed while experimenting with MemSQL:</p>

<h3>Pros</h3>

<ul>
<li>Blazing fast!</li>
<li>You can use all the MySQL client tools out there. Also because it uses MySQL, troubleshooting might not be an issue because it isn&#8217;t a new product.</li>
</ul>


<h3>Cons</h3>

<ul>
<li>Huge cache folder! After restoring the database (15Mb) MemSQL creates a folder in the <code>plancache</code> folder which is <strong>5.5GB</strong>. So performance comes with a price I think.</li>
<li>Unable to create users. When creating the database, I tried to add a new user but this isn&#8217;t supported. Maybe this is because I&#8217;m using the Developer Edition.</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Installing Android SKD for Eclipse]]></title>
    <link href="http://manuel.manuelles.nl/blog/2012/04/04/installing-android-skd-for-eclipse/"/>
    <updated>2012-04-04T09:53:00+02:00</updated>
    <id>http://manuel.manuelles.nl/blog/2012/04/04/installing-android-skd-for-eclipse</id>
    <content type="html"><![CDATA[<p><img class="right" src="http://manuel.manuelles.nl/images/posts/android.jpg" width="140" height="140" title="Android!" > Today I was trying to install the Android SDK for Eclipse for a new project I&#8217;ll work on. After downloading the necessary packages I got some strange error I couldn&#8217;t resolve quickly, so I like to share the solution with you guys.</p>

<p>The error Eclipse returned was</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Cannot complete the install because one or more required items could not be found.
</span><span class='line'>Software being installed: Android Development Tools **** (com.android.ide.eclipse.adt.feature.group ****)
</span><span class='line'>Missing requirement: Android Development Tools **** (com.android.ide.eclipse.adt.feature.group ****)
</span><span class='line'>requires 'org.eclipse.wst.sse.core 0.0.0' but it could not be found</span></code></pre></td></tr></table></div></figure>




<!-- more -->


<h2>What I did to produce the error</h2>

<p>I installed Eclipse and the Android SDK tested the Android SDK by creating an AVD.</p>

<p>After running Eclipse I tried to add the <code>https://dl-ssl.google.com/android/eclipse/</code> url to my Available Software Sites to install the Eclipse package. After selecting all the Developer Tools in the filtered list for this Software Site and hitting Next I received the error as I added above</p>

<h2>The solution</h2>

<p>After some googling I found a tip that I needed to add another Software Site to Eclipse.</p>

<p>After adding <code>http://download.eclipse.org/releases/indigo</code> and retrying to install the Android Developer Tools all went well.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Failed to build gem native extension]]></title>
    <link href="http://manuel.manuelles.nl/blog/2012/03/20/failed-to-build-gem-native-extension/"/>
    <updated>2012-03-20T13:14:00+01:00</updated>
    <id>http://manuel.manuelles.nl/blog/2012/03/20/failed-to-build-gem-native-extension</id>
    <content type="html"><![CDATA[<p><img class="left" src="http://manuel.manuelles.nl/images/posts/failed-gem.jpg" width="140" height="140" title="Go fix!" >
Today I had to reinstall my Linux installation because my harddisk died a quick dead. While configuring all the software I use to develop I got some weird error after I&#8217;d installed <a href="https://github.com/sstephenson/rbenv">rbenv</a> and tried to execute <code>bundle install</code> on one of our projects.<br /><br /></p>

<!-- more -->


<h2>The error</h2>

<p>The following error was raised when I tried to install capybara-webkit</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Installing capybara-webkit (0.10.1) with native extensions
</span><span class='line'>Gem::Installer::ExtensionBuildError: ERROR: Failed to build gem native extension.
</span><span class='line'>
</span><span class='line'>/home/manuel/.rbenv/versions/1.9.3-p125/bin/ruby extconf.rb
</span><span class='line'>sh: qmake: not found
</span><span class='line'>
</span><span class='line'>Gem files will remain installed in /home/manuel/.rbenv/versions/1.9.3-p125/lib/ruby/gems/1.9.1/gems/capybara-webkit-0.10.1 for inspection.
</span><span class='line'>Results logged to /home/manuel/.rbenv/versions/1.9.3-p125/lib/ruby/gems/1.9.1/gems/capybara-webkit-0.10.1/./gem_make.out
</span><span class='line'>An error occured while installing capybara-webkit (0.10.1), and Bundler cannot continue.
</span><span class='line'>Make sure that `gem install capybara-webkit -v '0.10.1'` succeeds before bundling.</span></code></pre></td></tr></table></div></figure>


<h2>The solution</h2>

<p>I first thought there were some problems with <code>make</code> or <code>cmake</code> because that&#8217;s what the error says. <code>qmake: not found</code>, but that didn&#8217;t seem to be te real problem.</p>

<p>After some googlefoo I found out that I was missing the <code>libqtwebkit-dev</code> package. So the problem in this case was easily resolved by running:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo apt-get install libqtwebkit-dev</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Mollie Bank]]></title>
    <link href="http://manuel.manuelles.nl/blog/2012/02/29/mollie-bank/"/>
    <updated>2012-02-29T21:29:00+01:00</updated>
    <id>http://manuel.manuelles.nl/blog/2012/02/29/mollie-bank</id>
    <content type="html"><![CDATA[<p>The past week I&#8217;ve been working with the iDeal API from Mollie. <a href="http://www.mollie.nl/">Mollie</a> is a company that give&#8217;s us developers an easy way to make iDeal payments through there API, for a small fee.</p>

<p>After a long search I wasn&#8217;t able to find a stable, well tested gem, I could use in our Rails project, so I developed the <a href="https://rubygems.org/gems/ideal-mollie">ideal-mollie gem</a>. After I finishing this gem, there was only one problem.</p>

<p>When you want to test a iDeal transaction with the Mollie test bank, you <strong>MUST</strong> do some routing, so that Mollie can send you a request if the payment was paid or not, to your local machine from the internet. So I made a alternative Mollie test bank you can use for what ever programming language you use for making Mollie iDeal payments without the routing problems.</p>

<!-- more -->


<h2>There&#8217;s a gem for that!</h2>

<p>I&#8217;ve came op with a gem that runs a small <a href="http://www.sinatrarb.com/">Sinatra</a> application that does exactly the same as the Mollie test bank, only it runs on your local machine, which means you can redirect to <code>localhost</code> and more important, it can perform the payment check.</p>

<p>Here you can find the <a href="https://rubygems.org/gems/mollie-bank">mollie-bank gem</a>, and the <a href="https://github.com/manuelvanrijn/mollie-bank">source code</a></p>

<p><img src="http://manuel.manuelles.nl/images/posts/mollie-bank.png"></p>

<h2>Install en run!</h2>

<p>To use mollie-bank just install the gem by running</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gem install mollie-bank</span></code></pre></td></tr></table></div></figure>


<p>and then run it</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mollie-bank</span></code></pre></td></tr></table></div></figure>


<p>At this point, you can go to <a href="http://localhost:4567/">http://localhost:4567/</a> and you&#8217;ll see an intro page.</p>

<h2>Setup your application</h2>

<p>Alright so now you only have to make sure that when you&#8217;re developing on your local machine, you don&#8217;t make the requests to Mollie but to your locally running Mollie Bank.</p>

<p>To do this you just have to change <code>https://secure.mollie.nl</code> into <code>http://localhost:4567</code> in you code.</p>

<h2>Todo</h2>

<p>At this point I&#8217;ve only wrote a sample implementation for <a href="http://rubyonrails.org/" title="Ruby on Rails">Ruby on Rails</a> on the <a href="https://github.com/manuelvanrijn/mollie-bank/wiki/Implement-into-existing-modules">Implement into existing modules Wiki</a> page, but soon there will be more examples.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[“Rake, pull me that DB!”]]></title>
    <link href="http://manuel.manuelles.nl/blog/2012/01/19/rake-pull-me-that-db/"/>
    <updated>2012-01-19T15:15:00+01:00</updated>
    <id>http://manuel.manuelles.nl/blog/2012/01/19/rake-pull-me-that-db</id>
    <content type="html"><![CDATA[<p>After writing my last article how to <a href="http://manuel.manuelles.nl/blog/2012/01/18/convert-postgresql-to-sqlite/" title="How to: Convert a PostgreSQL database to a SQLite database">Convert PostgreSQL to SQLite</a>, I was asked why this couldn&#8217;t be automated?</p>

<p>So I started coding and managed to create a <a href="http://rake.rubyforge.org/" title="Rake -- Ruby Make">Rake</a> task that will do all of the steps I described in the article in just a few seconds!</p>

<!-- more -->


<h2>Update</h2>

<p>Today a found a project that does exactly the samething as the below rake task, but with support for more db providers. <a href="http://www.herko.com">Heroku</a> uses this project for retrieving and pushing you database to the heroku database server.</p>

<p>The project is called Taps and can be found here: <a href="http://adam.heroku.com/past/2009/2/11/taps_for_easy_database_transfers/">http://adam.heroku.com/past/2009/2/11/taps_for_easy_database_transfers</a></p>

<h2>What will it do?</h2>

<ol>
<li>remove old dump and ssh the new dump to <code>tmp/dump.sql</code></li>
<li>converts the dumped SQL in to a valid format for SQLite</li>
<li>remembers the version number of the migration on the production db</li>
<li>backup, create and migrates the development SQLite to the version remembered</li>
<li>import the SQL</li>
<li>tell you all went well</li>
</ol>


<h2>Configuration</h2>

<p>To use the Rake task, you have to add 2 additional fields (<code>ssh_user</code> and <code>ssh_host</code>) to your <code>database.yml</code> file. These fields are used to create an ssh connection for retrieving the PostgreSQL dump.</p>

<p>Here&#8217;s example of a modified <code>config/database.yml</code>:</p>

<div><script src='https://gist.github.com/1640429.js?file=database.yml'></script>
<noscript><pre><code>development:
  adapter: sqlite3
  database: db/development.sqlite3
  pool: 5
  timeout: 5000

production:
  ssh_user: root                  # &lt;-- add username for ssh
  ssh_host: productionserver.com  # &lt;-- add hostname for ssh
  adapter: postgresql
  host: localhost
  port: 5432
  username: db_user
  password: db_pass
  database: db_name
  schema_search_path: public
  encoding: utf8
  template: template0</code></pre></noscript></div>


<h2>Get the Rake file</h2>

<p>Put the following code into <code>libs/tasks/database.rake</code></p>

<div><script src='https://gist.github.com/1640429.js?file=database.rake'></script>
<noscript><pre><code>require &#39;fileutils&#39;

namespace :db do
  desc &#39;pull the production PostgreSQL database into the development SQLite&#39;
  task :pull do
    Rake::Task[&#39;db:download_pg_dump&#39;].invoke
    Rake::Task[&#39;db:optimze_pg_dump_for_sqlite&#39;].invoke
    Rake::Task[&#39;db:recreate_with_dump&#39;].invoke
  end

  desc &#39;download the pg_dump content into tmp/dump.sql&#39;
  task :download_pg_dump do
    config = Rails.application.config.database_configuration

    abort &quot;Missing production database config&quot; if config[&#39;production&#39;].blank?

    dev  = config[&#39;development&#39;]
    prod = config[&#39;production&#39;]

    abort &quot;Development db is not sqlite3&quot; unless dev[&#39;adapter&#39;] =~ /sqlite3/
    abort &quot;Production db is not postgresql&quot; unless prod[&#39;adapter&#39;] =~ /postgresql/
    abort &quot;Missing ssh host&quot; if prod[&#39;ssh_host&#39;].blank?
    abort &quot;Missing database name&quot; if prod[&#39;database&#39;].blank?

    # remove the old one
    if File.exists?(pg_dump_file_path)
      File.delete(pg_dump_file_path)
    end

    cmd  = &quot;ssh -C &quot;
    cmd &lt;&lt; &quot;#{prod[&#39;ssh_user&#39;]}@&quot; if prod[&#39;ssh_user&#39;].present?
    cmd &lt;&lt; &quot;#{prod[&#39;ssh_host&#39;]} &quot;
    cmd &lt;&lt; &quot;PGPASSWORD=#{prod[&#39;password&#39;]} &quot;
    cmd &lt;&lt; &quot;pg_dump --data-only --inserts &quot;
    cmd &lt;&lt; &quot;--username=#{prod[&#39;username&#39;]} #{prod[&#39;database&#39;]} &gt; &quot;
    cmd &lt;&lt; pg_dump_file_path

    system `#{cmd}`
  end

  desc &#39;remove unused statements and optimze sql for SQLite&#39;
  task :optimze_pg_dump_for_sqlite do
    result = []
    lines = File.readlines(pg_dump_file_path)
    @version = 0
    lines.each do | line |
      next if line =~ /SELECT pg_catalog.setval/  # sequence value&#39;s
      next if line =~ /SET /                      # postgres specific config
      next if line =~ /--/                        # comment

      if line =~ /INSERT INTO schema_migrations/
        @version = line.match(/INSERT INTO schema_migrations VALUES \(&#39;([\d]*)/)[1]
      end

      # replace true and false for &#39;t&#39; and &#39;f&#39;
      line.gsub!(&quot;true&quot;,&quot;&#39;t&#39;&quot;)
      line.gsub!(&quot;false&quot;,&quot;&#39;f&#39;&quot;)
      result &lt;&lt; line
    end

    File.open(pg_dump_file_path, &quot;w&quot;) do |f|
      # Add BEGIN and END so we add it to 1 transaction. Increase speed!
      f.puts(&quot;BEGIN;&quot;)
      result.each{|line| f.puts(line) unless line.blank?}
      f.puts(&quot;END;&quot;)
    end
  end

  desc &#39;backup development.sqlite3 and create a new one with the dumped data&#39;
  task :recreate_with_dump do
    # sqlite so backup
    database = Rails.configuration.database_configuration[&#39;development&#39;][&#39;database&#39;]
    database_path = File.expand_path(&quot;#{Rails.root}/#{database}&quot;)
    # remove old backup
    if File.exists?(database_path + &#39;.backup&#39;)
      File.delete(database_path + &#39;.backup&#39;)
    end
    # copy current for backup
    FileUtils.cp database_path, database_path + &#39;.backup&#39; if File.exists?(database_path)

    # dropping and re-creating db
    ENV[&#39;VERSION&#39;] = @version
    Rake::Task[&#39;db:drop&#39;].invoke
    Rake::Task[&quot;db:migrate&quot;].invoke

    puts &quot;migrated to version: #{@version}&quot;
    puts &quot;importing...&quot;
    # remove migration info
    system `sqlite3 #{database_path} &quot;delete from schema_migrations;&quot;`
    # import dump.sql
    system `sqlite3 #{database_path} &quot;.read #{pg_dump_file_path}&quot;`

    puts &quot;DONE!&quot;
    puts &quot;NOTE: you&#39;re now migrated to version #{@version}. Please run db:migrate to apply newer migrations&quot;
  end

  def pg_dump_file_path
    File.expand_path(&quot;#{Rails.root}/tmp/dump.sql&quot;)
  end
end</code></pre></noscript></div>


<h2>Usage</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bundle exec rake db:pull</span></code></pre></td></tr></table></div></figure>


<h3>No SSH?</h3>

<p>If you want to skip the step where the rake tasks get&#8217;s the dump using ssh, you have to copy the dump.sql into the tmp folder by yourself (note that the name <strong>must</strong> be <code>dump.sql</code>)</p>

<p>After you copied it, you should execute the following commands, to generate the development database with the dumped sql.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bundle exec rake db:optimze_pg_dump_for_sqlite
</span><span class='line'>bundle exec rake db:recreate_with_dump</span></code></pre></td></tr></table></div></figure>


<h3>Want to skip entering the ssh password every time?</h3>

<p>You could generate a public/private key pair with RSA and append that key to the production server so you don&#8217;t have to enter the password over and over again to connect with ssh.</p>

<h4>1. Generate a public/private key pair with RSA</h4>

<p>First check if you haven&#8217;t already generated a <code>id_rsa</code> file in your <code>$HOME/.shh</code> folder. If you already have a <code>id_rsa</code> file continue with step 2.</p>

<p>Run the following command on you local machine and accept the defaults.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ssh-keygen -t rsa</span></code></pre></td></tr></table></div></figure>


<p>This command creates an RSA public/private key pair in your <code>$HOME/.ssh</code> directory. The private key is <code>~/.ssh/id_rsa</code> and the public key is <code>~/.ssh/id_rsa.pub</code></p>

<h4>2. Install public key on remote machine</h4>

<p>Now you can copy the public key to the remote machine by executing the following command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ssh-copy-id -i root@productionserver.com</span></code></pre></td></tr></table></div></figure>


<p>This command will ask you to enter the ssh password for the ssh user &#8220;root&#8221; for the hostname &#8220;productionserver.com&#8221;.</p>

<p>After you&#8217;ve enter the password (for the last time) you can create a ssh connection without entering the password by executing:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ssh root@productionserver.com</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Convert PostgreSQL to SQLite]]></title>
    <link href="http://manuel.manuelles.nl/blog/2012/01/18/convert-postgresql-to-sqlite/"/>
    <updated>2012-01-18T00:30:00+01:00</updated>
    <id>http://manuel.manuelles.nl/blog/2012/01/18/convert-postgresql-to-sqlite</id>
    <content type="html"><![CDATA[<p><img class="right" src="http://manuel.manuelles.nl/images/posts/postgres-to-sqlite.png" width="220" height="220" title="Postgres to SQLite" ></p>

<p>Today I&#8217;d like to share the steps I take when I need to convert a <a href="http://www.postgresql.org/" title="PostgreSQL">PostgreSQL</a> database into a <a href="http://www.sqlite.org/" title="SQLite">SQLite</a> database.</p>

<p>Commonly I have to do this when a <a href="http://rubyonrails.org/" title="Ruby on Rails">Ruby on Rails</a> application is in production and I have to check some issues with the production data. In the production environment we usually use a PostgreSQL database and for developing I use a SQLite database, so we need some conversion.</p>

<!-- more -->


<h2>Short story a.k.a I know what I&#8217;m doing.</h2>

<ol>
<li>Create a dump of the PostgreSQL database.
<code>ssh -C username@hostname.com pg_dump --data-only --inserts YOUR_DB_NAME &gt; dump.sql</code></li>
<li>Remove/modify the dump.

<ul>
<li>Remove the lines starting with <code>SET</code></li>
<li>Remove the lines starting with <code>SELECT pg_catalog.setval</code></li>
<li>Replace true for &#8216;t&#8217;</li>
<li>Replace false for &#8216;f&#8217;</li>
<li>Add <code>BEGIN;</code> as first line and <code>END;</code> as last line</li>
</ul>
</li>
<li>Recreate an empty development database.
<code>bundle exec rake db:migrate</code></li>
<li>Import the dump.</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sqlite3 db/development.sqlite3
</span><span class='line'>sqlite&gt; delete from schema_migrations;
</span><span class='line'>sqlite&gt; .read dump.sql
</span></code></pre></td></tr></table></div></figure>


<h2>Longer story a.k.a please explain a little more.</h2>

<p>So basically you can do the following 4 major steps to convert the PostgreSQL database into a SQLite database.</p>

<h3>1. Generate a SQL dump</h3>

<p>First we have to create a sql dump on the production server. I use the following command that results in a <code>dump.sql</code> file in the current folder:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>pg_dump --data-only --inserts YOUR_DB_NAME &gt; dump.sql
</span></code></pre></td></tr></table></div></figure>


<p>I use the <code>--data-only</code> option, so it doesn&#8217;t generate the schema. Converting the pg_dump generate schema to a valid SQLite schema gave me a lot of difficulties so I chose to generate the schema with the <code>rake db</code> task (we&#8217;ll discuss this in the next step).</p>

<p>After you created the dump, you have to download/transfer/mail/etc. that file so you have local access to it.</p>

<h4>Trick: Got ssh access?</h4>

<p>If you have ssh access, you can also run the following command, which will output the file directly on you local drive</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ssh -C username@hostname.com pg_dump --data-only --inserts YOUR_DB_NAME &gt; dump.sql
</span></code></pre></td></tr></table></div></figure>


<h3>2. Modify the dump.sql</h3>

<p>There are a few manual find/replace and delete action&#8217;s you have to perform on the <code>dump.sql</code> file by hand.</p>

<h4>2.1 Remove the <code>SET</code> statements at the top</h4>

<p>You will see some statements at the top of the file like <code>SET statement_timeout = 0;</code> and <code>SET client_encoding = 'SQL_ASCII';</code> etc. Remove all of these lines that start with <code>SET</code>, because SQLite doesn&#8217;t use these.</p>

<h4>2.2 Remove the setval sequence queries</h4>

<p>Under the <code>SET</code> queries you&#8217;ll see some queries to set the correct sequence for auto incrementing the id&#8217;s. SQLite doesn&#8217;t keep these value&#8217;s in a catalog and must be removed to prevent errors.</p>

<p>Remove all the line&#8217;s that look like <code>SELECT pg_catalog.setval('MY_OBJECT_id_seq', 10, true);</code></p>

<h4>2.3 Replace true => &#8216;t&#8217; and false => &#8216;f&#8217;</h4>

<p>The <code>pg_dump</code> generate&#8217;s <code>true</code> and <code>false</code> as value&#8217;s for the <code>INSERT INTO</code> statements. If we want to import these to SQLite we have to replace these to &#8216;t&#8217; and &#8216;f&#8217;.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="c1">-- These:</span>
</span><span class='line'><span class="k">INSERT</span> <span class="k">INTO</span> <span class="k">table_name</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span>
</span><span class='line'><span class="c1">-- Should be replace to:</span>
</span><span class='line'><span class="k">INSERT</span> <span class="k">INTO</span> <span class="k">table_name</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h4>2.4 Transactions. Make it fast!</h4>

<p>The first time I imported the dump (that was 2 mb) it took like 12 minutes to complete! After some googling I found out that SQLite&#8217;s default behavior is putting each statement into a transaction, which seems to be the time waster (after the fix it toke 12 seconds).</p>

<p>To prevent this behavior you can run the script within 1 transaction by specifying <code>BEGIN;</code> at the top of the <code>dump.sql</code> and <code>END;</code> at the end of the file.</p>

<p>So you would have:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">BEGIN</span><span class="p">;</span>
</span><span class='line'><span class="c1">-- a lot of INSERT INTO statments</span>
</span><span class='line'><span class="k">END</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>3. Recreate the development database</h3>

<p>So now we have fetched the production data from the PostgreSQL database, we need to recreate the <code>development.sqlite3</code> database.</p>

<p>Make a backup and run the migration task</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mv db/development.sqlite3 db/development.backup.sqlite3
</span><span class='line'>bundle <span class="nb">exec </span>rake db:migrate
</span></code></pre></td></tr></table></div></figure>


<h4>Side note when migrating</h4>

<p>You must run the migration <strong>until</strong> the migrated version that is active on the production database. If not, you could have the situation where you have dropped a column and can&#8217;t import the dump because the data depends on that column.</p>

<p>Check the <code>dump.sql</code> for the latest version number in the <code>schema_migrations</code> table and migrate to that version.</p>

<p>For example for the version <code>20121701120000</code> you would do:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bundle <span class="nb">exec </span>rake db:migrate <span class="nv">VERSION</span><span class="o">=</span>20121701120000
</span></code></pre></td></tr></table></div></figure>


<h3>4. Import the dump</h3>

<p>The final step is importing the dump file. To do this we have to execute the following command within a terminal:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sqlite3 db/development.sqlite3
</span><span class='line'>sqlite&gt; delete from schema_migrations;
</span><span class='line'>sqlite&gt; .read dump.sql
</span></code></pre></td></tr></table></div></figure>


<p>As you can see we first remove the records from the <code>schema_migrations</code> table, because these are also included in the <code>dump.sql</code>. Of course you could also remove the lines from the file, but I prefer this way.</p>

<p>The <code>.read</code> command just execute&#8217;s all the lines within the specified file.</p>

<h2>Result</h2>

<p>And that&#8217;s it! You now have a stuffed <code>development.sqlite3</code> database with all the production data out of the PostgreSQL database.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Disable Rails callback]]></title>
    <link href="http://manuel.manuelles.nl/blog/2012/01/12/disable-rails-before-slash-after-callback/"/>
    <updated>2012-01-12T21:30:00+01:00</updated>
    <id>http://manuel.manuelles.nl/blog/2012/01/12/disable-rails-before-slash-after-callback</id>
    <content type="html"><![CDATA[<p><img class="left" src="http://manuel.manuelles.nl/images/posts/skip-step.png" width="240" height="240" title="Skip Step" ></p>

<p>Today I&#8217;ve had some difficulties with a Rails migration, that took ages to complete. After some debugging I figured out that the issues was because of the <code>before_save</code> and <code>after_save</code> callbacks.</p>

<p>Of course we could remove the before and after save callbacks to speed up the process, but I don&#8217;t like the idea of releasing a model that misses these behavior. I mean they&#8217;re not there for no reason right?</p>

<!-- more -->


<p>After some googling I found a quick and easy way to disable the callbacks without modifying the model. Here&#8217;s an simple example of a model class and a migration the disable the callbacks only within the migration.</p>

<h2>Code solution</h2>

<figure class='code'><figcaption><span>app/models/some_model.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">SomeModel</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">before_save</span> <span class="ss">:before_action</span>
</span><span class='line'>  <span class="n">after_save</span> <span class="ss">:after_action</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">private</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">before_action</span>
</span><span class='line'>      <span class="c1"># heavy calculation/queries</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;you shouldn&#39;t see this&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">after_action</span>
</span><span class='line'>      <span class="c1"># another heavy calculation/queries</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;you shouldn&#39;t see this&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>db/migrations/20120112092136_update_some_model.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">UpdateSomeModel</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">up</span>
</span><span class='line'>    <span class="c1"># disable the before_save</span>
</span><span class='line'>    <span class="no">SomeModel</span><span class="o">.</span><span class="n">skip_callback</span><span class="p">(</span><span class="ss">:save</span><span class="p">,</span> <span class="ss">:before</span><span class="p">,</span> <span class="ss">:before_action</span><span class="p">)</span>
</span><span class='line'>    <span class="c1"># disable the after_save</span>
</span><span class='line'>    <span class="no">SomeModel</span><span class="o">.</span><span class="n">skip_callback</span><span class="p">(</span><span class="ss">:save</span><span class="p">,</span> <span class="ss">:after</span><span class="p">,</span> <span class="ss">:after_action</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="no">SomeModel</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span> <span class="n">obj</span> <span class="o">|</span>
</span><span class='line'>      <span class="c1"># .. modify obj ...</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">obj</span><span class="o">.</span><span class="n">save</span>
</span><span class='line'>      <span class="c1"># you shouldn&#39;t see the puts defined in the SomeModel before and after actions</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">down</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Supported callbacks</h2>

<p>In the above example I show only two rails callbacks. Here&#8217;s a list of the supported callbacks you also can disable with it.</p>

<ul>
<li><code>:after_initialize</code></li>
<li><code>:after_find</code></li>
<li><code>:after_touch</code></li>
<li><code>:before_validation</code></li>
<li><code>:after_validation</code></li>
<li><code>:before_save</code></li>
<li><code>:around_save</code></li>
<li><code>:after_save</code></li>
<li><code>:before_create</code></li>
<li><code>:around_create</code></li>
<li><code>:after_create</code></li>
<li><code>:before_update</code></li>
<li><code>:around_update</code></li>
<li><code>:after_update</code></li>
<li><code>:before_destroy</code></li>
<li><code>:around_destroy</code></li>
<li><code>:after_destroy</code></li>
<li><code>:after_commit</code></li>
<li><code>:after_rollback</code></li>
</ul>


<p>Hope these could help you out some day =)</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Shrinking your Git repository]]></title>
    <link href="http://manuel.manuelles.nl/blog/2011/12/22/shrinking-your-git-repository/"/>
    <updated>2011-12-22T15:01:00+01:00</updated>
    <id>http://manuel.manuelles.nl/blog/2011/12/22/shrinking-your-git-repository</id>
    <content type="html"><![CDATA[<p>In the past weeks I&#8217;ve looked into a problem that kept us from releasing to <a href="http://www.heroku.com/" title="Heroku">Heroku</a>, because the git repository was to large. In time the repository has grown to approximate <strong>180 Mb</strong>.</p>

<p><img class="right" src="http://manuel.manuelles.nl/images/posts/shrink-mario.jpg" width="140" height="140" title="Shrink!" ></p>

<p>In the past we&#8217;ve made some decisions that we probably wouldn&#8217;t take again. We for example, we decided to store the gem files in the vendor folder and having the rails code included in our repository. Our goal then was, that releasing the project with <a href="http://www.capify.org" title="Capistrano">Capistrano</a> would be easier and faster, because it didn&#8217;t have to download all the gem&#8217;s.</p>

<p>Anyway at this point we don&#8217;t have the gem&#8217;s stored anymore in the vendor folder. Since tools like <a href="http://beginrescueend.com/" title="Ruby version Manager">RVM</a> and <a href="https://github.com/sstephenson/rbenv/" title="rbenv">rbenv</a> we store these within the ruby/rails version of that specific project.</p>

<p>Still we have the problem that the repository contains files etc. we want to remove to shrink the size of it.</p>

<!-- more -->


<h2>Find large files from your git history</h2>

<p>First we have to track down what files are making our repository so large. I&#8217;ve found a perl script that scans your repository for files of a specific size. Here&#8217;s the code:</p>

<div><script src='https://gist.github.com/1354502.js'></script>
<noscript><pre><code>#!/usr/bin/perl
use 5.008;
use strict;
use Memoize;

# usage:
# git-large-files 500k
# git-large-files 0.5m
# git-large-files 5b

sub usage { die &quot;usage: git-large-files &lt;size[b|k|m]&gt; [&lt;git-log arguments ...&gt;]\n&quot; }

@ARGV or usage();
my ( $max_size, $unit ) = ( shift =~ /^(\d+)([bkm]?)\z/ ) ? ( $1, $2 ) : usage();

my $exp = 10 * ( $unit eq &#39;b&#39; ? 0 : $unit eq &#39;k&#39; ? 1 : 2 );
my $cutoff = $max_size * 2**$exp;

sub walk_tree {
    my ( $tree, @path ) = @_;
    my @subtree;
    my @r;

    {
        open my $ls_tree, &#39;-|&#39;, git =&gt; &#39;ls-tree&#39; =&gt; -l =&gt; $tree
            or die &quot;Couldn&#39;t open pipe to git-ls-tree: $!\n&quot;;

        while ( &lt;$ls_tree&gt; ) {
            my ( $type, $sha1, $size, $name ) = /\A[0-7]{6} (\S+) (\S+) +(\S+)\t(.*)/;
            if ( $type eq &#39;tree&#39; ) {
                push @subtree, [ $sha1, $name ];
            }
            elsif ( $type eq &#39;blob&#39; and $size &gt;= $cutoff ) {
                push @r, [ $size, @path, $name ];
            }
        }
    }

    push @r, walk_tree( $_-&gt;[0], @path, $_-&gt;[1] )
        for @subtree;

    return @r;
}

memoize &#39;walk_tree&#39;;

open my $log, &#39;-|&#39;, git =&gt; log =&gt; @ARGV, &#39;--pretty=format:%T %h %cr&#39;
    or die &quot;Couldn&#39;t open pipe to git-log: $!\n&quot;;

my %seen;
while ( &lt;$log&gt; ) {
    chomp;
    my ( $tree, $commit, $age ) = split &quot; &quot;, $_, 3;
    my $is_header_printed;
    for ( walk_tree( $tree ) ) {
        my ( $size, @path ) = @$_;
        my $path = join &#39;/&#39;, @path;
        next if $seen{ $path }++;
        print &quot;$commit $age\n&quot; if not $is_header_printed++;
        print &quot;\t$size\t$path\n&quot;;
    }
}</code></pre></noscript></div>


<p>So I&#8217;ve placed this file within my repository and executed the below command to see all files, from all commits, that are bigger then <strong>500 Kb</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>perl git-large-files.pl 500k</span></code></pre></td></tr></table></div></figure>


<p>This give&#8217;s you an output like:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>9794784 6 weeks ago
</span><span class='line'>  609280  vendor/cache/builder-3.0.0.gem
</span><span class='line'>  823808  vendor/cache/ffi-1.0.9.gem
</span><span class='line'>  801792  vendor/cache/gherkin-2.4.21.gem
</span><span class='line'>.... more ....
</span><span class='line'>874451c 3 months ago
</span><span class='line'>  609280  vendor/bundle/ruby/1.9.1/cache/builder-3.0.0.gem
</span><span class='line'>  823808  vendor/bundle/ruby/1.9.1/cache/ffi-1.0.9.gem
</span><span class='line'>  801792  vendor/bundle/ruby/1.9.1/cache/gherkin-2.4.21.gem
</span><span class='line'>.... more ....
</span><span class='line'>47ebdca 1 year, 1 month ago
</span><span class='line'>  15467626  vendor/gems/webrat-0.7.1/vendor/selenium-server.jar
</span><span class='line'>  6185324 vendor/rails/activerecord/examples/performance.sql
</span><span class='line'>  14465482  log/development.log</span></code></pre></td></tr></table></div></figure>


<p>As you can see the following folders contain data that we don&#8217;t need anymore and fills our repository with unused data:</p>

<ol>
<li>vendor/cache/*</li>
<li>vendor/bundle/*</li>
<li>vendor/rails/*</li>
<li>log/development.log</li>
</ol>


<h2>Removing the files from git</h2>

<p>To remove the folders specified above I used the commands specified by the <a href="http://help.github.com/remove-sensitive-data/" title="GitHub Help: Remove sensitive data">Remove sensitive data</a> post from GitHub Help</p>

<p>The only thing I changed was adding <code>-rf</code> to the <code>git rm</code> command to recursively force remove the files because I am dealing with multiple files/folders within the target folder.</p>

<h3>Rewrite history</h3>

<p>The final command I used was:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git filter-branch -f --index-filter 'git rm -rf --cached --ignore-unmatch vendor/cache/* vendor/bundle/* vendor/rails/* log/development.log' --prune-empty -- --all</span></code></pre></td></tr></table></div></figure>


<p>Mind the <code>vendor/cache/* vendor/bundle/* vendor/rails/* log/development.log</code> part. You can provide multiple path&#8217;s</p>

<p>When the command is finished, the history has been rewritten, but still the size of the repository hasn&#8217;t changed at this point.</p>

<h3>Cleanup and reclaim space</h3>

<p>You have to execute the following commands to also remove the files from you local repository.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rm -rf .git/refs/original/
</span><span class='line'>git reflog expire --expire=now --all
</span><span class='line'>git gc --aggressive --prune=now</span></code></pre></td></tr></table></div></figure>


<p>Now we can force push our repository so that others can enjoy our effort.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git push origin master --force</span></code></pre></td></tr></table></div></figure>


<h2>The result (98,55% smaller)</h2>

<p>After following the above steps our repository was shrinked by <strong>98,55 %!</strong>. First the repository was 180 Mb and now it is <strong>2.6 Mb</strong></p>

<p>Ofcourse we had this numbers because there were alot of gem files within our repository that were updated frequently and pushed over and over again to the master branch.</p>

<p>I hope this post will help other&#8217;s to track large files within there git repository and how they can remove them to shrink the size of there repostiories.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Intro: Start blogging like a hacker(?)]]></title>
    <link href="http://manuel.manuelles.nl/blog/2011/12/08/intro-start-blogging-like-a-hacker/"/>
    <updated>2011-12-08T15:28:00+01:00</updated>
    <id>http://manuel.manuelles.nl/blog/2011/12/08/intro-start-blogging-like-a-hacker</id>
    <content type="html"><![CDATA[<p>I&#8217;ve just decided to switch from <a href="http://www.wordpress.com/" title="Wordpress">Wordpress</a> to <a href="http://octopress.org/" title="Octopress">Octopress</a> because I wanted something new and not something over-featured</p>

<p>All the plugins and choice&#8217;s I had to made, and the maintenance of all these, just kept me from doing what I supposed to do with it, blogging.</p>

<p><span class='pullquote-right' data-pullquote='A blogging framework for hackers.'>
So after some googling what a good alternative would be for Wordpress I found <em>Octopress</em> A blogging framework for hackers. Alright +1 for the title
</span></p>

<p>So basically Octopress generates (bakes) HTML content from the <a href="http://daringfireball.net/projects/markdown/" title="Markdown">Markdown</a> content you write. I like this simplicity and I love the syntax.</p>

<p><a href="http://octopress.org/" title="Octopress">Octopress</a> give&#8217;s you the functionality to host it on your own server, but also to host it on <a href="http://www.heroku.com/" title="Heroku">Heroku</a> or <a href="https://github.com/" title="Github">Github</a>. Beside the Git approach (push your source and deploy the generated code to the master branch) you can use RSync to sync files to your server. I use <a href="https://github.com" title="Github">Github</a> to store my source and generated html.</p>

<p>Enough talking about <a href="http://octopress.org/" title="Octopress">Octopress</a> for now. I&#8217;ll hope to post my next post soon.</p>
]]></content>
  </entry>
  
</feed>
